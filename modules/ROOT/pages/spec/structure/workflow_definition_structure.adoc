= Workflow Definition Structure

:uri_wiki_url: https://en.wikipedia.org/wiki/Uniform_Resource_Identifier

[cols="1,3,1,1"]
|===
|Parameter  |Description |Type |Required

|id
|Workflow unique identifier	
|string
|yes if `key` not defined

|key
|Domain-specific workflow identifier	
|string
|yes if `id` not defined

|name	
|Workflow name	
|string
|no

|description
|Workflow description	
|string
|no

|version	
|Workflow version	
|string
|no

|annotations
|List of helpful terms describing the workflows intended purpose, subject areas, or other important qualities	
|array
|no

|dataInputSchema
|Used to validate the workflow data input against a defined JSON Schema	
|string or object	
|no

|xref:spec/constants.adoc[constants]
|Workflow constants	
|string or object	
|no

|xref:spec/secrets.adoc[secrets]
|Workflow secrets	
|string or array	
|no

|xref:spec/structure/state_definitions/start.adoc[start]
|Workflow start definition	
|string
|no

|specVersion
|Serverless Workflow specification release version	
|string
|yes

|expressionLang	
|Identifies the expression language used for workflow expressions. Default value is "jq"	
|string
|no

|xref:spec/workflow_timeouts.adoc[timeouts]
|Defines the workflow default timeout settings	
|string or object	
|no

|xref:spec/errors.adoc[errors]
|Defines checked errors that can be explicitly handled during workflow execution	
|string or array	
|no

|keepActive
|If "true", workflow instances is not terminated when there are no active execution paths. Instance can be terminated with "terminate end definition" or reaching defined "workflowExecTimeout"	
|boolean	
|no

|xref:spec/structure/state_definitions/auth.adoc[auth]
|Workflow authentication definitions	
|array or string	
|no

|xref:spec/structure/state_definitions/event.adoc[events]
|Workflow event definitions.	
|array or string	
|no

|xref:spec/structure/state_definitions/function.adoc[functions]
|Workflow function definitions. Can be either inline function definitions (if array) or URI pointing to a resource containing json/yaml function definitions (if string)	
|array or string	
|no

|autoRetries
|If set to true, xref:spec/structure/state_definitions/action.adoc[actions] should automatically be retried on unchecked errors. Default is false	
|boolean
|no

|xref:spec/structure/state_definitions/retry.adoc[retries]
|Workflow retries definitions. Can be either inline retries definitions (if array) or URI pointing to a resource containing json/yaml retry definitions (if string)	
|array or string	
|no

|xref:spec/structure/states/workflow_states.adoc[states]
|Workflow states	
|array
|yes

|xref:spec/metadata.adoc[metadata]
|Metadata information	
|object
|no

|===

.Workflow Example Definition
[tabs]
====
YAML::
+
--
[source,yaml]
----
id: sampleWorkflow
version: '1.0'
specVersion: '0.8'
name: Sample Workflow
description: Sample Workflow
start: MyStartingState
states: []
functions: []
events: []
errors: []
retries: []
----
--
JSON::
+
--
[source,json]
----
{
   "id": "sampleWorkflow",
   "version": "1.0",
   "specVersion": "0.8",
   "name": "Sample Workflow",
   "description": "Sample Workflow",
   "start": "MyStartingState",
   "states": [],
   "functions": [],
   "events": [],
   "errors": [],
   "retries":[]
}
----
--
====

Defines the top-level structure of a serverless workflow model. Following figure describes the main workflow definition blocks.

image::spec/workflowdefinitionblocks.png[]

The `id` property defines the unique, domain-specific workflow identifier, for example "orders", "payment", etc.

The `key` property defines the unique, domain-specific workflow identifier. It can be used when the `id` property is auto-generated by a content-management system for example. In these cases, you can specify the `key` property to be the domain-specific identifier of the workflow definition. The `id` and `key` properties are mutually exclusive, meaning you cannot define both.

The `name` property is the workflow logical name.

The `description` property can be used to give further information about the workflow.

The `version` property can be used to provide a specific workflow version.

The `annotations` property defines a list of helpful terms describing the workflows intended purpose, subject areas, or other important qualities, for example "machine learning", "monitoring", "networking", etc

The `dataInputSchema` property can be used to validate the workflow data input against a defined JSON Schema. This check should be done before any states are executed.  `dataInputSchema` can have two different types. If it is an object type it has the following definition:

[source,json]
----
"dataInputSchema": {
   "schema": "URL_to_json_schema",
   "failOnValidationErrors": false
}
----

It's `schema` property is an URI which points to the JSON schema used to validate the workflow data input. It' `failOnValidationErrors` property determines if workflow execution should continue in case of validation errors. The default value of `failOnValidationErrors` is true. If `dataInputSchema` has the string type, it has the following definition:

[source,json]
----
"dataInputSchema": "URL_to_json_schema"
----

In this case the `failOnValidationErrors` default value of `true` is assumed.

The `dataInputSchema` property validates the xref:spec/data/workflow_data.adoc#data_input[workflow data input]. In case of a starting xref:spec/structure/states/event.adoc[Event state], it is not used to validate its event payloads.

The `secrets` property allows you to use sensitive information such as passwords, OAuth tokens, ssh keys, etc. inside your Workflow expressions.

It has two possible types, `string` or `array`. If `string` type, it is an URI pointing to a JSON or YAML document which contains an array of names of the secrets, for example:

[source,json]
----
"secrets": "file://workflowsecrets.json"
----

If `array` type, it defines an array (of string types) which contains the names of the secrets, for example:

[source,json]
----
"secrets": ["MY_PASSWORD", "MY_STORAGE_KEY", "MY_ACCOUNT"]
----

For more information about Workflow secrets, reference the xref:spec/secrets.adoc[Workflow Secrets section].

The constants property can be used to define Workflow constants values which are accessible in xref:spec/workflow_expressions.adoc[Workflow Expressions].

It has two possible types, `string` or `object`. If `string` type, it is an URI pointing to a JSON or YAML document which contains an object of global definitions, for example:

[source,json]
----
"constants": "file://workflowconstants.json"
----

If `object` type, it defines a JSON object which contains the constants definitions, for example:

[source,json]
----
{
  "AGE": {
    "MIN_ADULT": 18
  }
}
----

For more information see the xref:spec/constants.adoc[Workflow Constants] section.

The `start` property defines the workflow starting information. For more information see the xref:spec/structure/state_definitions/start.adoc[start definition] section. This property is not required. If not defined, the workflow starting state has to be the very first state defined in the xref:spec/structure/states/workflow_states.adoc[workflow states array].

The `specVersion` property is used to set the Serverless Workflow specification release version the workflow markup adheres to. It has to follow the specification release versions (excluding the leading "v"), meaning that for the link:{spec_repo_versioned_url}[release version v{page-version}] its value should be set to `"{page-version}"`.

The `expressionLang` property can be used to identify the expression language used for all expressions in the workflow definition. The default value of this property is link:{jq_url}["jq"]. You should set this property if you chose to define xref:spec/workflow_expressions.adoc[workflow expressions] with an expression language / syntax other than the default.

The `timeouts` property is used to define the default workflow timeouts for workflow, state, action, and branch execution. For more information about timeouts and its use cases see the xref:spec/workflow_timeouts.adoc[Workflow Timeouts] section.

The `error` property is used to define checked errors that can be explicitly handled during workflow execution. For more information about workflow error handling see xref:spec/errors.adoc#defining_errors[this section].

The `auth` property can be either an inline xref:spec/structure/state_definitions/auth.adoc[auth] definition array, or a URI reference to a resource containing an array of xref:spec/structure/state_definitions/auth.adoc[auth] definitions. If defined in a separate resource file (Json or Yaml), `auth` definitions can be re-used by multiple workflow definitions. Auth definitions can be used to define authentication that should be used to access the resource defined in the `operation` property of the xref:spec/structure/state_definitions/function.adoc[function] definitions. If we have the following function definition:

[source,json]
----
{
   "functions": [
      {
         "name": "HelloWorldFunction",
         "operation": "https://secure.resources.com/myapi.json#helloWorld",
         "authRef": "My Basic Auth"
      }
   ]
}
----

The `authRef` property is used to reference an authentication definition in the `auth` property and should be applied to access the `https://secure.resources.com/myapi.json` OpenApi definition file.

The `functions` property can be either an in-line xref:spec/structure/state_definitions/function.adoc[function] definition array, or an URI reference to a resource containing an array of xref:spec/structure/state_definitions/function.adoc[functions] definition. Referenced resource can be used by multiple workflow definitions.

Here is an example of using external resource for function definitions:

1. Workflow definition:
+
[source,json]
----
{
   "id": "sampleWorkflow",
   "version": "1.0",
   "specVersion": "0.8",
   "name": "Sample Workflow",
   "description": "Sample Workflow",
   "start": "MyStartingState",
   "functions": "http://myhost:8080/functiondefs.json",
   "states":[
     ...
   ]
}
----
+
2. Function definitions resource:
+
[source,json]
----
{
   "functions": [
      {
         "name":"HelloWorldFunction",
         "operation":"file://myapi.json#helloWorld"
      }
   ]
}
----

Referenced resource must conform to the specifications link:{spec_repo_versioned_url}/schema/functions.json[Workflow Functions JSON Schema].

The `events` property can be either an in-line xref:spec/structure/state_definitions/event.adoc[event] definition array, or an link:{uri_wiki_url}[URI] reference to a resource containing an array of xref:spec/structure/state_definitions/event.adoc[event] definition. Referenced resource can be used by multiple workflow definitions.

Here is an example of using external resource for event definitions:

1. Workflow definition:
+
[source,json]
----
{
   "id": "sampleWorkflow",
   "version": "1.0",
   "specVersion": "0.8",
   "name": "Sample Workflow",
   "description": "Sample Workflow",
   "start": "MyStartingState",
   "events": "http://myhost:8080/eventsdefs.json",
   "states":[
     ...
   ]
}
----
+
2. Event definitions resource:
+
[source,json]
----
{
   "events": [
      {
         "name": "ApplicantInfo",
         "type": "org.application.info",
         "source": "applicationssource",
         "correlation": [
          {
            "contextAttributeName": "applicantId"
          }
         ]
      }
   ]
}
----

Referenced resource must conform to the specifications link:{spec_repo_versioned_url}/schema/events.json[Workflow Events JSON Schema].

The `retries` property can be either an in-line xref:spec/structure/state_definitions/retry.adoc[retry] definition array, or an URI reference to a resource containing an array of xref:spec/structure/state_definitions/retry.adoc[retry] definition. Referenced resource can be used by multiple workflow definitions. For more information about using and referencing retry definitions see the xref:spec/errors.adoc[Workflow Error Handling] section.

The `keepActive` property allows you to change the default behavior of workflow instances. By default, as described in the Core Concepts section, a workflow instance is terminated once there are no more active execution paths, one of its active paths ends in a "terminate" xref:spec/structure/state_definitions/end.adoc[end definition], or when its xref:spec/workflow_timeouts.adoc[`workflowExecTimeout`] time is reached.

Setting the keepActive property to "true" allows you to change this default behavior in that a workflow instance created from this workflow definition can only be terminated if one of its active paths ends in a "terminate" end definition, or when its workflowExecTimeout time is reached. This allows you to explicitly model workflows where an instance should be kept alive, to collect (event) data for example.

You can reference the xref:examples:index.adoc[specification examples] to see the `keepActive` property in action.
